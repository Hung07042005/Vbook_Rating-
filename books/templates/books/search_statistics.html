{% extends 'books/base.html' %}
{% block title %}Th·ªëng k√™ t√¨m ki·∫øm{% endblock %}
{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">Th·ªëng k√™ t√¨m ki·∫øm</h1>
    <div class="row mb-4">
        <div class="col-md-6">
            <h5 class="mb-2">üîé T·ª´ kh√≥a ƒë∆∞·ª£c t√¨m nhi·ªÅu nh·∫•t</h5>
            <canvas id="topKeywordsChart" height="180"></canvas>
            <ul class="list-group mb-3 mt-3">
                {% for kw in top_keywords %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span>{{ kw.query }}</span>
                    <span class="badge bg-primary rounded-pill">{{ kw.count }}</span>
                </li>
                {% empty %}
                <li class="list-group-item">Kh√¥ng c√≥ d·ªØ li·ªáu</li>
                {% endfor %}
            </ul>
            <h5 class="mb-2">‚ùå T·ª´ kh√≥a kh√¥ng c√≥ k·∫øt qu·∫£</h5>
            <ul class="list-group mb-3">
                {% for kw in no_result_keywords %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span>{{ kw.query }}</span>
                    <span class="badge bg-danger rounded-pill">{{ kw.count }}</span>
                </li>
                {% empty %}
                <li class="list-group-item">Kh√¥ng c√≥ d·ªØ li·ªáu</li>
                {% endfor %}
            </ul>
        </div>
        <div class="col-md-6">
            <h5 class="mb-2">üë§ T√°c gi·∫£ ƒë∆∞·ª£c xem nhi·ªÅu</h5>
            <canvas id="topAuthorsChart" height="180"></canvas>
            <ul class="list-group mb-3 mt-3">
                {% for author in top_authors %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span>{{ author.name }}</span>
                    <span class="badge bg-success rounded-pill">{{ author.view_count }}</span>
                </li>
                {% empty %}
                <li class="list-group-item">Kh√¥ng c√≥ d·ªØ li·ªáu</li>
                {% endfor %}
            </ul>
            <h5 class="mb-2">üìö S√°ch ƒë∆∞·ª£c xem nhi·ªÅu</h5>
            <ul class="list-group mb-3">
                {% for book in top_books %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span>{{ book.title }}</span>
                    <span class="badge bg-info rounded-pill">{{ book.view_count }}</span>
                </li>
                {% empty %}
                <li class="list-group-item">Kh√¥ng c√≥ d·ªØ li·ªáu</li>
                {% endfor %}
            </ul>
            <h5 class="mb-2">üè∑Ô∏è Th·ªÉ lo·∫°i ƒë∆∞·ª£c t√¨m nhi·ªÅu</h5>
            <ul class="list-group mb-3">
                {% for genre in top_genres %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span>{{ genre.name }}</span>
                    <span class="badge bg-warning rounded-pill">{{ genre.search_count }}</span>
                </li>
                {% empty %}
                <li class="list-group-item">Kh√¥ng c√≥ d·ªØ li·ªáu</li>
                {% endfor %}
            </ul>
        </div>
    </div>
    <h5 class="mb-3">üïë L·ªãch s·ª≠ t√¨m ki·∫øm g·∫ßn ƒë√¢y</h5>
    <table class="table table-bordered table-hover">
        <thead>
            <tr>
                <th>Ng∆∞·ªùi d√πng</th>
                <th>T·ª´ kh√≥a t√¨m ki·∫øm</th>
                <th>Th·ªùi gian</th>
            </tr>
        </thead>
        <tbody>
            {% for log in logs %}
            <tr>
                <td>{% if log.user %}{{ log.user.username }}{% else %}Kh√°ch{% endif %}</td>
                <td>{{ log.query }}</td>
                <td>{{ log.searched_at|date:'d/m/Y H:i' }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="3" class="text-center">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Truy·ªÅn d·ªØ li·ªáu cho Chart.js b·∫±ng json_script -->
{{ top_keywords|json_script:"topKeywordsData" }}
{{ top_authors|json_script:"topAuthorsData" }}
{% endblock %}

{% block script %}
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// D·ªØ li·ªáu cho top t·ª´ kh√≥a
const topKeywords = JSON.parse(document.getElementById('topKeywordsData').textContent);
const keywordLabels = topKeywords.map(item => item.query);
const keywordCounts = topKeywords.map(item => item.count);

const ctxKeywords = document.getElementById('topKeywordsChart').getContext('2d');
if (keywordLabels.length > 0) {
    new Chart(ctxKeywords, {
        type: 'bar',
        data: {
            labels: keywordLabels,
            datasets: [{
                label: 'S·ªë l∆∞·ª£t t√¨m ki·∫øm',
                data: keywordCounts,
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
        }
    });
}
// D·ªØ li·ªáu cho top t√°c gi·∫£
const topAuthors = JSON.parse(document.getElementById('topAuthorsData').textContent);
const authorLabels = topAuthors.map(item => item.name);
const authorCounts = topAuthors.map(item => item.view_count);

const ctxAuthors = document.getElementById('topAuthorsChart').getContext('2d');
if (authorLabels.length > 0) {
    new Chart(ctxAuthors, {
        type: 'bar',
        data: {
            labels: authorLabels,
            datasets: [{
                label: 'L∆∞·ª£t xem',
                data: authorCounts,
                backgroundColor: 'rgba(40, 167, 69, 0.6)',
                borderColor: 'rgba(40, 167, 69, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
        }
    });
}
</script>
{% endblock %}
